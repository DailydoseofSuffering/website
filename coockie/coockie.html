<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cookie</title>
	<style>
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
			background: radial-gradient(120% 120% at 20% 20%, rgba(34,211,238,0.08), transparent 40%),
				radial-gradient(120% 120% at 80% 0%, rgba(52,211,153,0.08), transparent 45%),
				#0b1224;
			color: #e5e7eb;
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.cookie-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
			gap: 16px;
		}
		.global-count {
			font-size: clamp(12px, 2vw, 16px);
			color: #9ca3af;
			text-align: center;
		}
		.global-count.hidden { display: none; }
		.cookie-image {
			width: min(360px, 70vw);
			height: auto;
			cursor: pointer;
			user-select: none;
			transition: transform 120ms ease;
		}
		.cookie-image:active { transform: scale(0.98); }
		.cookie-image.bite { animation: bite 180ms ease-in-out; }
		.cookie-image.hidden { display: none; }
		.message {
			font-size: clamp(18px, 3vw, 28px);
			font-weight: 600;
			color: #e5e7eb;
			text-align: center;
			cursor: pointer;
			user-select: none;
		}
		.message.hidden { display: none; }
		@keyframes bite {
			0% { transform: scale(1); }
			50% { transform: scale(0.92) rotate(-2deg); }
			100% { transform: scale(1); }
		}
	</style>
</head>
<body>
	<div class="cookie-container" id="cookieContainer">
		<div id="startMessage" class="message">You have done well, have a coockie &lt;3</div>
		<div id="doneMessage" class="message hidden"></div>
		<div id="globalCount" class="global-count hidden"></div>
		<img
			id="cookieImage"
			class="cookie-image hidden"
			src="coockie-4_4.png"
			alt="Cookie"
			aria-live="polite"
		>
	</div>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
		import { getFirestore, doc, getDoc, setDoc, onSnapshot, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
		import { firebaseConfig } from '../firebase-config.js';

		// Initialize Firebase
		let app, db;
		let useLocalStorage = false;
		try {
			app = initializeApp(firebaseConfig);
			db = getFirestore(app);
		} catch (error) {
			console.warn('Firebase initialization failed. Falling back to localStorage:', error);
			useLocalStorage = true;
		}

		const stages = [
			'coockie-4_4.png',
			'coockie-3_4.png',
			'coockie-2_3.png',
			'coockie-1_4.png',
			null
		];

		const img = document.getElementById('cookieImage');
		const container = document.getElementById('cookieContainer');
		const startMessage = document.getElementById('startMessage');
		const doneMessage = document.getElementById('doneMessage');
		const globalCountEl = document.getElementById('globalCount');
		let index = 0;
		let animating = false;
		let cookieCount = 0;
		let globalTotal = 0;

		// Load global count from Firebase
		const loadGlobalCount = async () => {
			if (useLocalStorage) {
				try {
					globalTotal = parseInt(localStorage.getItem('cookie-global-total') || '0', 10);
				} catch (e) {
					globalTotal = 0;
				}
			} else {
				try {
					const docRef = doc(db, 'cookie', 'cookie');
					const docSnap = await getDoc(docRef);
					if (docSnap.exists()) {
						globalTotal = docSnap.data()['cookie-total'] || 0;
					} else {
						await setDoc(docRef, { 'cookie-total': 0 });
						globalTotal = 0;
					}
				} catch (e) {
					console.error('Failed to load global count:', e);
					globalTotal = 0;
				}
			}
		};

		// Increment global count in Firebase
		const incrementGlobalCount = async () => {
			if (useLocalStorage) {
				globalTotal += 1;
				localStorage.setItem('cookie-global-total', globalTotal.toString());
			} else {
				try {
					const docRef = doc(db, 'cookie', 'cookie');
					await setDoc(docRef, { 'cookie-total': increment(1) }, { merge: true });
					globalTotal += 1;
				} catch (e) {
					console.error('Failed to increment global count:', e);
				}
			}
		};

		// Listen for real-time updates
		const setupRealtimeListener = () => {
			if (!useLocalStorage && db) {
				const docRef = doc(db, 'cookie', 'cookie');
				onSnapshot(docRef, (docSnap) => {
					if (docSnap.exists()) {
						globalTotal = docSnap.data()['cookie-total'] || 0;
						updateGlobalCountDisplay();
					}
				}, (error) => {
					console.error('Error listening to Firebase updates:', error);
				});
			}
		};

		const updateGlobalCountDisplay = () => {
			if (!globalCountEl.classList.contains('hidden')) {
				globalCountEl.textContent = `Global: ${globalTotal} coockies eaten worldwide`;
			}
		};

		const showCookie = () => {
			startMessage.classList.add('hidden');
			doneMessage.classList.add('hidden');
			globalCountEl.classList.add('hidden');
			img.classList.remove('hidden');
			img.setAttribute('aria-hidden', 'false');
			setStage(index);
		};

		const showStartMessage = () => {
			img.classList.add('hidden');
			img.setAttribute('aria-hidden', 'true');
			doneMessage.classList.add('hidden');
			globalCountEl.classList.add('hidden');
			startMessage.classList.remove('hidden');
		};

		const showDoneMessage = async () => {
			img.classList.add('hidden');
			img.setAttribute('aria-hidden', 'true');
			startMessage.classList.add('hidden');
			doneMessage.textContent = `You have had ${cookieCount} coockie`;
			doneMessage.classList.remove('hidden');
			globalCountEl.textContent = `Global: ${globalTotal} coockies eaten worldwide`;
			globalCountEl.classList.remove('hidden');
		};

		const setStage = async (nextIndex) => {
			index = nextIndex;
			const src = stages[index];
			if (!src) {
				cookieCount += 1;
				await incrementGlobalCount();
				showDoneMessage();
				return;
			}
			img.src = src;
		};

		const handleClick = (event) => {
			event.stopPropagation();
			if (animating) return;
			if (stages[index] === null) {
				setStage(0);
				return;
			}
			animating = true;
			img.classList.add('bite');
			setTimeout(() => {
				img.classList.remove('bite');
				setStage(index + 1);
				animating = false;
			}, 180);
		};

		img.addEventListener('click', handleClick);
		startMessage.addEventListener('click', () => {
			index = 0;
			showCookie();
		});
		doneMessage.addEventListener('click', () => {
			index = 0;
			showCookie();
		});

		// Initialize
		(async () => {
			await loadGlobalCount();
			setupRealtimeListener();
			showStartMessage();
		})();
	</script>
</body>
</html>
